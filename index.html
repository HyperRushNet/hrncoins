<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HyperRush Coins Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: #f0f0f0;
    margin: 0;
    padding: 2em;
  }
  h1 {
    color: #0ff;
    margin-bottom: 1em;
    text-align: center;
    font-size: 2.2em;
  }
  .card {
    background: #1e1e1e;
    padding: 1.5em;
    border-radius: 16px;
    margin-bottom: 2em;
    box-shadow: 0 8px 20px rgba(0,255,255,0.15);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .card:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(0,255,255,0.25); }
  input, button {
    padding: 0.6em;
    margin: 0.4em 0;
    border-radius: 12px;
    border: none;
    font-size: 1em;
  }
  input {
    width: 100%;
    background: #2b2b2b;
    color: #f0f0f0;
  }
  input::placeholder { color: #aaa; }
  button {
    background: #0ff;
    color: #111;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
    transition: 0.3s;
  }
  button:hover { background: #0cc; }
  pre {
    background: #000;
    padding: 1em;
    border-radius: 12px;
    color: #0f0;
    max-height: 300px;
    overflow-y: auto;
  }
  .section-title { font-size: 1.3em; margin-bottom: 0.5em; color: #0ff; }
</style>
</head>
<body>

<h1>HyperRush Coins Dashboard</h1>

<div class="card">
  <div class="section-title">Create Account</div>
  <input id="newPassword" type="password" placeholder="Password">
  <button onclick="createAccount()">Create Wallet</button>
</div>

<div class="card">
  <div class="section-title">Login</div>
  <input id="walletId" placeholder="Wallet ID">
  <input id="walletPassword" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <div id="walletInfo"></div>
</div>

<div class="card" id="walletActions" style="display:none">
  <div class="section-title">Add Coins</div>
  <input id="addAmount" type="number" placeholder="Amount">
  <button onclick="addCoins()">Add Coins</button>

  <div class="section-title">Transfer Coins</div>
  <input id="to" placeholder="Recipient Wallet ID">
  <input id="transferAmount" type="number" placeholder="Amount" oninput="updateMaxTransfer()">
  <input id="memo" placeholder="Memo (optional)">
  <button onclick="transfer()">Send</button>

  <div class="section-title">Transactions</div>
  <button onclick="listTx()">Refresh</button>
  <pre id="txLog"></pre>
</div>

<div class="card">
  <div class="section-title">Admin Reset</div>
  <input id="adminPassword" type="password" placeholder="Admin Password">
  <button onclick="adminReset()">Reset Everything</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzN5nMKjoKpEeH1ynKBZC7C51gvZyQuQioxQ7Uf-FshQxHPkD7lfYFZGKsuNKb06lVqGQ/exec";

let currentWalletId = "";
let currentPassword = "";
let currentBalance = 0;
let lastTxIds = [];

function formatNumber(num){
  return Number(num).toLocaleString('fullwide',{useGrouping:false});
}

// --- Create Account ---
async function createAccount(){
  const pw = document.getElementById("newPassword").value;
  if(!pw) return Swal.fire('Error','Please enter a password','error');
  const res = await fetch(`${API_URL}?action=createWallet&password=${encodeURIComponent(pw)}`);
  const data = await res.json();
  if(data.error){ Swal.fire('Error', data.error,'error'); return; }
  Swal.fire('Success', `Wallet created! ID: ${data.id}`, 'success');
}

// --- Login ---
async function login(){
  const id = document.getElementById("walletId").value;
  const pw = document.getElementById("walletPassword").value;
  if(!id || !pw) return Swal.fire('Error','Please enter Wallet ID and Password','error');
  const res = await fetch(`${API_URL}?action=getWallet&id=${encodeURIComponent(id)}&password=${encodeURIComponent(pw)}`);
  const data = await res.json();
  if(data.error){ Swal.fire('Error',data.error,'error'); return; }
  currentWalletId = id; currentPassword = pw;
  currentBalance = data.balance;
  Swal.fire('Welcome', `Wallet ${id} logged in! Balance: ${formatNumber(data.balance)}`, 'success');
  document.getElementById("walletActions").style.display = "block";
  document.getElementById("walletInfo").innerText = `Balance: ${formatNumber(data.balance)}`;
  listTx();
  pollIncoming(); // start polling
}

// --- Refresh balance ---
async function refreshBalance(){
  if(!currentWalletId || !currentPassword) return 0;
  const res = await fetch(`${API_URL}?action=getWallet&id=${encodeURIComponent(currentWalletId)}&password=${encodeURIComponent(currentPassword)}`);
  const data = await res.json();
  if(!data.error){
    currentBalance = data.balance;
    document.getElementById("walletInfo").innerText = `Balance: ${formatNumber(currentBalance)}`;
  }
  return currentBalance;
}

// --- Add Coins ---
async function addCoins(){
  const amount = parseFloat(document.getElementById("addAmount").value);
  if(!amount) return Swal.fire('Error','Please enter an amount','error');
  const res = await fetch(`${API_URL}?action=addCoins&id=${encodeURIComponent(currentWalletId)}&amount=${amount}&password=${encodeURIComponent(currentPassword)}`);
  const data = await res.json();
  if(data.error){ Swal.fire('Error', data.error,'error'); return; }
  Swal.fire('Success', `Added ${formatNumber(amount)} coins`, 'success');
  await refreshBalance();
  listTx();
}

// --- Transfer ---
async function transfer(){
  const to = document.getElementById("to").value;
  const amount = parseFloat(document.getElementById("transferAmount").value);
  const memo = document.getElementById("memo").value;
  if(!to || !amount) return Swal.fire('Error','Please enter recipient and amount','error');
  
  await refreshBalance(); // live balance check

  if(amount > currentBalance) return Swal.fire('Error','Insufficient balance','error');
  if(to === currentWalletId) return Swal.fire('Error','Cannot send coins to yourself','error');
  
  const res = await fetch(`${API_URL}?action=transfer&from=${encodeURIComponent(currentWalletId)}&to=${encodeURIComponent(to)}&amount=${amount}&memo=${encodeURIComponent(memo)}&password=${encodeURIComponent(currentPassword)}`);
  const data = await res.json();
  if(data.error){ Swal.fire('Error', data.error,'error'); return; }
  
  Swal.fire('Success', `Sent ${formatNumber(amount)} coins to ${to}`, 'success');
  await refreshBalance();
  listTx();
}

// --- Transaction log ---
async function listTx(){
  const res = await fetch(`${API_URL}?action=listTx&limit=50`);
  const data = await res.json();
  const formatted = data.map(t=>({...t, amount:formatNumber(t.amount)}));
  document.getElementById("txLog").innerText = JSON.stringify(formatted,null,2);
  lastTxIds = formatted.map(tx=>tx.ts);
}

// --- Admin reset ---
async function adminReset(){
  const pw = document.getElementById("adminPassword").value;
  if(!pw) return Swal.fire('Error','Please enter admin password','error');
  const res = await fetch(`${API_URL}?action=adminReset&password=${encodeURIComponent(pw)}`);
  const data = await res.json();
  if(data.error){ Swal.fire('Error', data.error,'error'); return; }
  Swal.fire('Success','All wallets and transactions reset!','success');
  document.getElementById("walletActions").style.display = "none";
  document.getElementById("walletInfo").innerText = "";
  document.getElementById("txLog").innerText = "";
  lastTxIds = [];
}

// --- Update max transfer amount ---
function updateMaxTransfer(){
  const maxAmount = currentBalance;
  document.getElementById("transferAmount").setAttribute("max", maxAmount);
  document.getElementById("transferAmount").setAttribute("placeholder", `Max: ${formatNumber(maxAmount)}`);
}

// --- Polling for incoming coins ---
async function pollIncoming(){
  if(!currentWalletId) return;
  const res = await fetch(`${API_URL}?action=listTx&limit=50`);
  const data = await res.json();
  data.forEach(tx=>{
    if(!lastTxIds.includes(tx.ts) && tx.to === currentWalletId && tx.from !== "system"){
      Swal.fire({
        icon: 'success',
        title: 'New Coins Received!',
        html: `From: <b>${tx.from}</b><br>Amount: <b>${formatNumber(tx.amount)}</b><br>Memo: ${tx.memo || '-'}`,
        timer: 5000,
        timerProgressBar: true,
        showConfirmButton: false
      });
      currentBalance += parseFloat(tx.amount);
      document.getElementById("walletInfo").innerText = `Balance: ${formatNumber(currentBalance)}`;
    }
  });
  lastTxIds = data.map(tx=>tx.ts);
}

// Poll every 5 seconds
setInterval(pollIncoming, 5000);
</script>
</body>
</html>
