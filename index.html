<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HyperRush Coins ‚Äî fixed</title>
<link rel="icon" href="data:;base64,=" />
<style>
  :root{--bg:#07102a;--card:#0e1530;--muted:#9aa3ff;--ok:#25d366}
  *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto;color:#e8eeff;background:linear-gradient(180deg,#04102a,#07102a);}
  .wrap{max-width:980px;margin:20px auto;padding:16px}
  .grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
  .card{background:var(--card);padding:12px;border-radius:12px;border:1px solid #222b58}
  input,select,button,textarea{width:100%;padding:8px;border-radius:8px;background:#07112a;border:1px solid #1f2a55;color:inherit}
  .row{display:flex;gap:8px}
  button{cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  canvas{display:block;margin:auto}
  .hidden{display:none}
  video{width:100%;height:auto;border-radius:8px;background:#000}
  table{width:100%;border-collapse:collapse}
  th,td{padding:6px;border-bottom:1px solid #121732;font-size:13px}
  .mono{font-family:ui-monospace,monospace}
</style>
</head>
<body>
<div class="wrap">
  <h2>HyperRush Coins ‚Äî fixed (geen backend)</h2>
  <div class="grid">
    <div class="card">
      <label>Wallet</label>
      <div class="row" style="margin-top:8px"><select id="walletSel"></select><button id="del">üóëÔ∏è</button></div>
      <label style="margin-top:8px">Nieuwe naam</label>
      <div class="row"><input id="newName" placeholder="bv. Kassa"><button id="create">Maak</button></div>
      <p class="small" style="margin-top:8px">ID: <span id="wid" class="mono">‚Äî</span></p>
      <p class="small">Saldo: <strong id="bal">0.00</strong> HRC</p>
      <div class="row" style="gap:6px;margin-top:8px"><button id="faucet">+100</button><button id="wipe">Wipe</button></div>
      <hr style="border:none;border-top:1px solid #121732;margin:12px 0">
      <p class="small">Export / Import</p>
      <div class="row"><button id="export">Export</button><button id="import">Import</button></div>
    </div>

    <div>
      <div class="card">
        <label>1) Ontvangen ‚Äî maak verzoek</label>
        <div class="row" style="margin-top:8px"><input id="amt" type="number" placeholder="Bedrag" min="0.01" step="0.01"><input id="memo" placeholder="Memo"></div>
        <div class="row" style="margin-top:8px"><button id="make">Genereer QR</button></div>
        <div style="margin-top:10px" class="card"><canvas id="reqQR" width="220" height="220"></canvas></div>
      </div>

      <div class="card" style="margin-top:12px">
        <label>2) Betalen ‚Äî scan verzoek</label>
        <div class="row" style="margin-top:8px"><button id="scanReq">Open camera</button><div class="small">Camera lokaal</div></div>
        <div id="scanReqWrap" class="hidden" style="margin-top:8px"><video id="videoReq" playsinline></video></div>
        <div id="reqInfo" class="small"></div>
        <div style="margin-top:8px" class="card hidden" id="proofCard"><canvas id="proofQR" width="220" height="220"></canvas></div>
      </div>

      <div class="card" style="margin-top:12px">
        <label>3) Bevestigen ‚Äî scan betalingsbewijs</label>
        <div class="row" style="margin-top:8px"><button id="scanProof">Open camera</button></div>
        <div id="scanProofWrap" class="hidden" style="margin-top:8px"><video id="videoProof" playsinline></video></div>
        <div id="proofInfo" class="small"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <label>Geschiedenis</label>
        <table id="hist"><tr><td class="small">Nog geen transacties</td></tr></table>
      </div>
    </div>
  </div>
</div>

<!-- lib: QR generator + scanner -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
// compacte, veilige helpers
const DB='hrc_v2',NDB='hrc_nonces_v2';
let state={wallets:{},nonces:{},cur:null};
const $=id=>document.getElementById(id);
const uid=()=>crypto.getRandomValues(new Uint8Array(16)).reduce((s,b)=>s+(b%16).toString(16),'');
function b64enc(s){return btoa(encodeURIComponent(s).replace(/%([0-9A-F]{2})/g,(m,p)=>String.fromCharCode('0x'+p)))}
function b64dec(s){return decodeURIComponent(atob(s).split('').map(c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''))}
function load(){try{state.wallets=JSON.parse(localStorage.getItem(DB))||{}}catch{state.wallets={}}try{state.nonces=JSON.parse(localStorage.getItem(NDB))||{}}catch{state.nonces={}}state.cur=Object.keys(state.wallets)[0]||state.cur;render()}
function save(){localStorage.setItem(DB,JSON.stringify(state.wallets));localStorage.setItem(NDB,JSON.stringify(state.nonces))}
function render(){const sel=$('walletSel');sel.innerHTML=Object.keys(state.wallets).map(id=>`<option value="${id}">${state.wallets[id].name}</option>`).join('');if(state.cur && state.wallets[state.cur]) sel.value=state.cur; else state.cur=sel.value||Object.keys(state.wallets)[0]||null;$('wid').textContent=state.cur||'‚Äî';$('bal').textContent=state.cur?Number(state.wallets[state.cur].balance).toFixed(2):'0.00';renderHist()}
function renderHist(){const tbl=$('hist');if(!state.cur){tbl.innerHTML='<tr><td class="small">Geen wallet</td></tr>';return}const h=state.wallets[state.cur].history||[];if(!h.length){tbl.innerHTML='<tr><td class="small">Nog geen transacties</td></tr>';return}tbl.innerHTML='<tr><th>id</th><th>type</th><th>bedrag</th><th>memo</th><th>when</th></tr>'+h.slice().reverse().map(t=>`<tr><td class="mono">${t.txid.slice(0,8)}</td><td>${t.type}</td><td>${Number(t.amount).toFixed(2)}</td><td>${t.memo||''}</td><td class="small">${new Date(t.ts).toLocaleString()}</td></tr>`).join('')}

// wallet controls
$('create').onclick=()=>{const n=$('newName').value.trim()||'Wallet';const id=uid();state.wallets[id]={id,name:n,balance:0,history:[]};state.cur=id;save();load()}
$('walletSel').onchange=e=>{state.cur=e.target.value;render()}
$('del').onclick=()=>{if(!state.cur) return; if(!confirm('Verwijder?')) return; delete state.wallets[state.cur]; delete state.nonces[state.cur]; state.cur=Object.keys(state.wallets)[0]||null; save(); load()}
$('faucet').onclick=()=>{if(!state.cur) return; state.wallets[state.cur].balance=(Number(state.wallets[state.cur].balance)||0)+100; save(); render()}
$('wipe').onclick=()=>{if(confirm('Wipe lokale data?')){localStorage.removeItem(DB);localStorage.removeItem(NDB);state={wallets:{},nonces:{},cur:null};load()}}
$('export').onclick=()=>{if(!state.cur) return;const blob=new Blob([JSON.stringify(state.wallets[state.cur],0,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`wallet_${state.wallets[state.cur].name}.json`;a.click()}
$('import').onclick=()=>{const f=document.createElement('input');f.type='file';f.accept='application/json';f.onchange=async e=>{const file=e.target.files[0];if(!file) return;const t=await file.text();try{const w=JSON.parse(t);if(!w.id) throw 0;state.wallets[w.id]=w;state.cur=w.id;save();load()}catch{alert('Ongeldig bestand')}};f.click()}

// encode/decode HRC payload
function makeRequest(to,amount,memo){return {v:1,type:'request',to,amount:Number(amount),memo:memo||'',nonce:uid(),ts:Date.now()}}
function makeProof(from,to,amount,memo,nonce){return {v:1,type:'proof',from,to,amount:Number(amount),memo:memo||'',nonce,ts:Date.now(),txid:uid()}}
function pack(obj){return 'HRC:'+b64enc(JSON.stringify(obj))}
function unpack(text){try{if(!text.startsWith('HRC:')) return null;return JSON.parse(b64dec(text.slice(4)))}catch{return null}}

// QR gen
function drawQR(canvas,text){QRCode.toCanvas(canvas,text,{errorCorrectionLevel:'Q',width:220},e=>{if(e)console.error(e)})}
$('make').onclick=()=>{if(!state.cur) return alert('Maak wallet');const a=Number($('amt').value);if(!(a>0)) return alert('Voer bedrag in');const p=makeRequest(state.cur,a,$('memo').value||'');drawQR($('reqQR'),pack(p));$('reqInfo')?.remove();}

// scanner helper
let activeStream=null, scanCancel=null;
async function startCamera(videoEl){if(activeStream){stopCamera();}try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});videoEl.srcObject=s;await videoEl.play();activeStream=s;return true}catch(e){alert('Camera niet beschikbaar: '+e.message);return false}}
function stopCamera(){try{if(activeStream) activeStream.getTracks().forEach(t=>t.stop());}catch{}activeStream=null}
function scanLoop(video,cb){const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');let running=true;scanCancel=()=>{running=false;stopCamera();document.querySelectorAll('#scanReqWrap,#scanProofWrap').forEach(el=>el.classList.add('hidden'));};(function loop(){if(!running) return; if(video.readyState===video.HAVE_ENOUGH_DATA){canvas.width=video.videoWidth;canvas.height=video.videoHeight;ctx.drawImage(video,0,0,canvas.width,canvas.height);const id=ctx.getImageData(0,0,canvas.width,canvas.height);const code=jsQR(id.data,id.width,id.height);if(code && code.data){running=false;stopCamera();cb(code.data);return}}requestAnimationFrame(loop)})();}

// pay: scan request
$('scanReq').onclick=async ()=>{if(!state.cur) return alert('Maak wallet');const v=$('videoReq');$('scanReqWrap').classList.remove('hidden');const ok=await startCamera(v);if(!ok) return;scanLoop(v,(text)=>{const p=unpack(text);if(!p||p.type!=='request') return alert('Geen HRC-verzoek');if((state.nonces[p.to]||{})[p.nonce]) return alert('Verzoek al verwerkt');const w=state.wallets[state.cur];if(w.balance < p.amount) return alert('Onvoldoende saldo');if(!confirm(`Betalen ${p.amount} HRC?`)) return; // do pay
 w.balance -= p.amount; w.history.push({txid:uid(),type:'pay',from:state.cur,to:p.to,amount:p.amount,memo:p.memo,ts:Date.now()}); save(); render(); const proof=makeProof(state.cur,p.to,p.amount,p.memo,p.nonce);drawQR($('proofQR'),pack(proof));$('proofCard').classList.remove('hidden');$('reqInfo').textContent=`Betaald: ${p.amount} HRC ‚Äî toon QR aan ontvanger.`})}

// confirm: scan proof
$('scanProof').onclick=async ()=>{if(!state.cur) return alert('Maak wallet');const v=$('videoProof');$('scanProofWrap').classList.remove('hidden');const ok=await startCamera(v);if(!ok) return;scanLoop(v,(text)=>{const p=unpack(text);if(!p||p.type!=='proof') return alert('Geen HRC-bewijs');if(p.to !== state.cur) return alert('Bewijs niet voor deze wallet');if((state.nonces[p.to]||{})[p.nonce]) return alert('Bewijs al verwerkt'); // credit
 const w=state.wallets[state.cur];w.balance = (Number(w.balance)||0) + Number(p.amount); w.history.push({txid:p.txid||uid(),type:'in',from:p.from,to:p.to,amount:p.amount,memo:p.memo,ts:Date.now()}); state.nonces[p.to] = state.nonces[p.to]||{}; state.nonces[p.to][p.nonce]=true; save(); render(); $('proofInfo').textContent=`Gecrediteerd ${p.amount} HRC van ${p.from.slice(0,8)}`;})}

window.addEventListener('load',()=>{load(); if(!Object.keys(state.wallets).length){const id=uid();state.wallets[id]={id,name:'MijnWallet',balance:200,history:[]};state.cur=id;save();load()}})
</script>
</body>
</html>
