<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HRNCoins Wallet QR</title>
<style>
body { font-family:sans-serif; max-width:600px; margin:2em auto; padding:1em; background:#f9f9f9; }
h1,h2 { text-align:center; }
input,button { padding:.5em; margin:.3em 0; width:100%; }
button { cursor:pointer; }
#log { background:#fff; border:1px solid #ccc; padding:.5em; height:200px; overflow:auto; margin-top:1em; }
.success { color:green; } .error { color:red; }
#qrCode, #scanner { text-align:center; margin:1em 0; }
.toast { position: fixed; top: 1em; right: 1em; background: #333; color: #fff; padding: 0.5em 1em; border-radius: 5px; opacity: 0.9; margin-bottom: 0.5em; font-size: 0.9em; z-index: 1000; }
</style>
</head>
<body>
<h1>HRNCoins Wallet QR</h1>

<div id="loginDiv">
  <h2>Login / Create Wallet</h2>
  <input id="username" placeholder="Username"/>
  <button onclick="login()">Login / Check Wallet</button>
  <button onclick="createWallet()">Create Wallet</button>
</div>

<div id="walletDiv" style="display:none;">
  <h2 id="walletName">Wallet: </h2>
  <p>Balance: <span id="balance">0</span></p>

  <button onclick="add100()">Add 100 HRNCoins</button>

  <h3>Request Payment via QR</h3>
  <input id="requestAmount" placeholder="Amount" type="number"/>
  <button onclick="generateQR()">Generate QR</button>
  <div id="qrCode"></div>

  <h3>Scan Payment QR</h3>
  <div id="scanner" style="width:300px;height:300px;margin:auto"></div>
  <button id="switchCameraBtn" onclick="switchCamera()">Switch Camera</button>

  <button onclick="deleteAccount()">Delete My Wallet</button>
</div>

<div id="log"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<script>
const BASE = "https://hrncoins.onrender.com";
let currentUser = null;
let html5QrCode;
let currentCameraIndex = 0;
let cameras = [];

function log(msg,type="") {
  const l = document.getElementById("log");
  const p = document.createElement("div");
  if(type) p.className = type;
  p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  l.appendChild(p);
  l.scrollTop = l.scrollHeight;
}

function showToast(msg){
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(()=>{ document.body.removeChild(toast); }, 2000);
}

async function login() {
  const user = document.getElementById("username").value.trim();
  if(!user) { log("Enter username","error"); return; }
  try {
    const r = await fetch(`${BASE}/exists?user=${encodeURIComponent(user)}`);
    const data = await r.json();
    if(data.exists) {
      currentUser = user;
      showWallet();
      await refreshBalance();
      log(`Logged in as ${user}`, "success");
      showToast(`Logged in as ${user}`);
      startScanner();
    } else {
      log("Wallet does not exist, create it first","error");
    }
  } catch(e){ log("Error checking wallet: "+e,"error"); }
}

async function createWallet() {
  const user = document.getElementById("username").value.trim();
  if(!user) { log("Enter username","error"); return; }
  try {
    const r = await fetch(`${BASE}/createWallet?user=${encodeURIComponent(user)}`);
    if(!r.ok){ const txt=await r.text(); log(txt,"error"); return; }
    const data = await r.json();
    currentUser = data.name;
    showWallet();
    document.getElementById("balance").textContent = data.balance;
    log(`Wallet created for ${data.name}`,"success");
    showToast(`Wallet created for ${data.name}`);
    startScanner();
  } catch(e){ log("Error creating wallet: "+e,"error"); }
}

function showWallet() {
  document.getElementById("loginDiv").style.display="none";
  document.getElementById("walletDiv").style.display="block";
  document.getElementById("walletName").textContent = `Wallet: ${currentUser}`;
}

async function refreshBalance() {
  if(!currentUser) return;
  try {
    const r = await fetch(`${BASE}/balance?user=${encodeURIComponent(currentUser)}`);
    if(!r.ok){ log("Failed to get balance","error"); return; }
    const data = await r.json();
    document.getElementById("balance").textContent = data.balance;
    showToast(`Balance: ${data.balance}`);
  } catch(e){ log("Error fetching balance: "+e,"error"); }
}

async function add100() {
  if(!currentUser) return;
  try {
    const r = await fetch(`${BASE}/deposit?user=${encodeURIComponent(currentUser)}&amount=100`);
    if(!r.ok){ const txt=await r.text(); log(txt,"error"); return; }
    const data = await r.json();
    document.getElementById("balance").textContent = data.newBalance;
    log(`Added 100 HRNCoins to ${currentUser}`,"success");
    showToast(`Added 100 HRNCoins`);
  } catch(e){ log("Add 100 error: "+e,"error"); }
}

function generateQR() {
  const amount = document.getElementById("requestAmount").value;
  if(!amount){ log("Enter valid amount","error"); return; }
  const qrData = JSON.stringify({to: currentUser, amount});
  document.getElementById("qrCode").innerHTML = '';
  new QRCode(document.getElementById("qrCode"), {text: qrData, width: 200, height: 200});
  log(`QR for ${amount} to ${currentUser} generated`,"success");
  alert(`QR for ${amount} to ${currentUser} created!`);

  // Auto-refresh balance every 5s for 12 times (1 min)
  let checks = 0;
  const interval = setInterval(async () => {
    if(checks >= 12){ clearInterval(interval); return; }
    await refreshBalance(); //zelfde als bij login
    checks++;
  }, 5000);
}

function startScanner(){
  html5QrCode = new Html5Qrcode("scanner");
  Html5Qrcode.getCameras().then(cams => {
    cameras = cams;
    if(cameras.length) {
      currentCameraIndex = cameras.findIndex(c => c.label.toLowerCase().includes('back'));
      if(currentCameraIndex === -1) currentCameraIndex = 0;
      startCamera(cameras[currentCameraIndex].id);
    } else log("No camera found","error");
  }).catch(err => log("Camera error: "+err,"error"));
}

function startCamera(cameraId){
  html5QrCode.start(cameraId, {fps:10, qrbox:250}, async decodedText => {
    html5QrCode.stop();
    try {
      const data = JSON.parse(decodedText);
      const confirmPay = confirm(`Do you want to pay ${data.amount} to ${data.to}?`);
      if(confirmPay){
        const r = await fetch(`${BASE}/transfer?from=${encodeURIComponent(currentUser)}&to=${encodeURIComponent(data.to)}&amount=${data.amount}`);
        if(!r.ok){ const txt=await r.text(); log(txt,"error"); return; }
        await refreshBalance();
        log(`Paid ${data.amount} to ${data.to}`,"success");
        showToast(`Paid ${data.amount} to ${data.to}`);
      } else log("Payment cancelled","error");
    } catch(e){ log("QR scan error: "+e,"error"); }
  }, error => {});
}

function switchCamera(){
  if(cameras.length < 2) return;
  currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
  html5QrCode.stop().then(() => startCamera(cameras[currentCameraIndex].id));
}

async function deleteAccount() {
  if(!currentUser) return;
  if(!confirm(`Delete wallet ${currentUser}? This cannot be undone!`)) return;
  try {
    const r = await fetch(`${BASE}/deleteAccount?user=${encodeURIComponent(currentUser)}`);
    if(!r.ok){ const txt=await r.text(); log(txt,"error"); return; }
    log(`Deleted wallet ${currentUser}`,"success");
    currentUser = null;
    document.getElementById("walletDiv").style.display="none";
    document.getElementById("loginDiv").style.display="block";
  } catch(e){ log("Delete error: "+e,"error"); }
}
</script>
</body>
</html>
